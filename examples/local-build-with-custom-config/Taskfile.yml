version: 3

env:
  SOLO_COMMAND:
    sh: |
      if [ "${USE_RELEASED_VERSION}" = "true" ]; then
        echo "npx @hashgraph/solo"
      else
        echo "npm run solo --"
      fi

vars:
  NODE_IDENTIFIERS: "node1,node2"
  SOLO_NETWORK_SIZE: "2"
  DEPLOYMENT: "deployment-localbuild-with-custom-config"
  NAMESPACE: "namespace-localbuild-with-custom-config"
  CLUSTER_NAME: "localbuild-with-custom-config-cluster"
  CONTEXT: "kind-localbuild-with-custom-config-cluster"
  CLUSTER_REFERENCE: "kind-localbuild-with-custom-config-cluster"

  ROOT_DIR:
    sh: git rev-parse --show-toplevel
  CN_LOCAL_BUILD_PATH: "{{.ROOT_DIR}}/../hiero-consensus-node/hedera-node/data"
  LOCAL_BUILD_FLAG: "--local-build-path {{.CN_LOCAL_BUILD_PATH}}"

  CN_VERSION: "0.63.0"
  RELAY_RELEASE_FLAG: "--relay-release 0.70.1"
  MIRROR_NODE_VERSION_FLAG: "--mirror-node-version v0.143.0"
  EXPLORER_VERSION_FLAG: "--explorer-version 25.0.0"

  BLOCK_NODE_VALUE_FILE_FLAG: "--values-file {{ .USER_WORKING_DIR }}/block-node-values.yaml"
  MIRROR_NODE_VALUE_FILE_FLAG: "--values-file {{ .USER_WORKING_DIR }}/mirror-node-values.yaml"
  RELAY_NODE_VALUE_FILE_FLAG: "--values-file {{ .USER_WORKING_DIR }}/relay-node-values.yaml"
  EXPLORER_NODE_VALUE_FILE_FLAG: "--values-file {{ .USER_WORKING_DIR }}/hiero-explorer-values.yaml"
tasks:
  default:
    desc: Run a full standalone Solo network with local built consensus node and block node, mirror node, and relay
    cmds:

      # Solo node setup
      - cmd: $SOLO_COMMAND consensus node setup --node-aliases {{ .NODE_IDENTIFIERS }} --deployment {{ .DEPLOYMENT }} {{.LOCAL_BUILD_FLAG}}

      # Solo node start
      - cmd: $SOLO_COMMAND consensus node start --deployment {{ .DEPLOYMENT }} --node-aliases {{ .NODE_IDENTIFIERS }}

      # Solo mirror node add
      - cmd: $SOLO_COMMAND mirror node add --deployment {{ .DEPLOYMENT }} --pinger --enable-ingress {{ .MIRROR_NODE_VERSION_FLAG }} {{ .MIRROR_NODE_VALUE_FILE_FLAG }}

      # Solo relay node add
      - cmd: $SOLO_COMMAND relay node add --deployment {{ .DEPLOYMENT }} --node-aliases {{ .NODE_IDENTIFIERS }} {{ .RELAY_RELEASE_FLAG }} {{ .RELAY_NODE_VALUE_FILE_FLAG }}

      # Solo explorer node add
      - cmd: |
          $SOLO_COMMAND explorer node add --deployment {{ .DEPLOYMENT }} \
          --enable-explorer-tls --tls-cluster-issuer-type acme-staging \
          --enable-ingress \
          -n {{ .EXPLORER_NAME_SPACE }} \
          {{ .EXPLORER_VERSION_FLAG }} {{ .EXPLORER_NODE_VALUE_FILE_FLAG }}

      - cmd: |
          $SOLO_COMMAND deployment diagnostics logs --deployment {{ .DEPLOYMENT }} 

  destroy:
    desc: Destroy the Solo network with block node
    cmds:
      # solo consensus node stop
      - cmd: $SOLO_COMMAND consensus node stop --deployment {{ .DEPLOYMENT }} --node-aliases {{ .NODE_IDENTIFIERS }}

      # solo mirror node destroy
      - cmd: $SOLO_COMMAND mirror node destroy --deployment {{ .DEPLOYMENT }} --force

      # solo relay node destroy
      - cmd: $SOLO_COMMAND relay node destroy --deployment {{ .DEPLOYMENT }} --node-aliases {{ .NODE_IDENTIFIERS }}

      # solo explorer node destroy
      - cmd: $SOLO_COMMAND explorer node destroy --deployment {{ .DEPLOYMENT }}

      # solo block node destroy
      - cmd: $SOLO_COMMAND block node destroy --deployment {{ .DEPLOYMENT }}

      # solo consensus network destroy
      - cmd: $SOLO_COMMAND consensus network destroy --deployment {{ .DEPLOYMENT }} --force

      # Delete Kind cluster
      - cmd: kind delete cluster -n {{ .CLUSTER_NAME }}
