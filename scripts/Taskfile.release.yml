version: '3'
# This Taskfile handles dual-namespace publishing tasks for the release process.
# It can be used in CI/CD pipelines or run locally.
# Example usage:
# task -t scripts/Taskfile.release.yml dual-publish:rename
# task -t scripts/Taskfile.release.yml dual-publish:pack DRY_RUN=true OUTPUT_DIR=output/hl
# task -t scripts/Taskfile.release.yml dual-publish:restore

tasks:
  dual-publish:rename:
    desc: Rename package references from Hashgraph namespace to Hiero namespace
    dir: '{{.TASKFILE_DIR}}/..'
    vars:
      HASHGRAPH_PKG_NAME: '{{.HASHGRAPH_PKG_NAME | default "@hashgraph/solo"}}'
      HIERO_PKG_NAME: '{{.HIERO_PKG_NAME | default "@hiero-ledger/solo"}}'
      IGNORE_LIST_FILE: '{{.IGNORE_LIST_FILE | default ".github/workflows/support/.ignore-deploy-release"}}'
    cmds:
      - |
        cp package.json package.json.tmp
        jq --arg to "{{.HIERO_PKG_NAME}}" '.name = $to' package.json.tmp > package.json
        rm package.json.tmp
      - |
        tracked_files=$(git grep -rl --text "{{.HASHGRAPH_PKG_NAME}}" || true)
        if [[ -z "${tracked_files}" ]]; then
          echo "No files found containing '{{.HASHGRAPH_PKG_NAME}}'; skipping."
          exit 0
        fi

        if [[ ! -f "{{.IGNORE_LIST_FILE}}" ]]; then
          echo "Warning: ignore list '{{.IGNORE_LIST_FILE}}' not found; skipping filter step."
          filtered_files="${tracked_files}"
        else
          filtered_files=$(echo "${tracked_files}" | grep -vFf "{{.IGNORE_LIST_FILE}}" || true)
        fi

        if [[ -z "${filtered_files}" ]]; then
          echo "No files to update after filtering; skipping replacement."
          exit 0
        fi

        if [[ "{{OS}}" == "darwin" ]]; then
          echo "${filtered_files}" | tr '\n' '\0' | \
            xargs -0 sed -i '' 's/@hashgraph\/solo/@hiero-ledger\/solo/g'
        else
          echo "${filtered_files}" | tr '\n' '\0' | \
            xargs -0 sed -i 's/\b@hashgraph\/solo\b/@hiero-ledger\/solo/g'
        fi
        echo "Updated $(echo "${filtered_files}" | wc -l | tr -d ' ') files."

  dual-publish:pack:
    desc: Install dependencies, build, and pack the npm package
    dir: '{{.TASKFILE_DIR}}/..'
    vars:
      OUTPUT_DIR: '{{.OUTPUT_DIR | default "output/hl"}}'
      DRY_RUN: '{{.DRY_RUN | default "false"}}'
    cmds:
      - npm install
      - task build
      - mkdir -p "{{.OUTPUT_DIR}}"
      - |
        FLAGS=""
        if [ "{{.DRY_RUN}}" == "true" ]; then 
          FLAGS="--dry-run"
        fi
        npm pack --pack-destination "{{.OUTPUT_DIR}}" ${FLAGS}

  # Assumes no git ops have been performed since the rename task.
  dual-publish:restore:
    desc: Restore original package references after packing
    dir: '{{.TASKFILE_DIR}}/..'
    cmds:
      - git restore .
